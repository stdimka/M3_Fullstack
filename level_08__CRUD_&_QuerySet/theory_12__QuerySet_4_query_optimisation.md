# ะะฟัะธะผะธะทะฐัะธั ะทะฐะฟัะพัะพะฒ
---
๐ ะกััั ะฟัะพะฑะปะตะผั "ะฝะตะพะฟัะธะผะฐะปัะฝะพััะธ" ะทะฐะฟัะพัะพะฒ:

ะะพะณะดะฐ ะผั ะพะฑัะฐัะฐะตะผัั ะบ ัะฒัะทะฐะฝะฝัะผ ะผะพะดะตะปัะผ (ัะตัะตะท ForeignKey, ManyToMany ะธ ั.ะฟ.),  
ัะพ Django ะฟะพ ัะผะพะปัะฐะฝะธั ะดะตะปะฐะตั **ะพัะดะตะปัะฝัะน(!)** SQL-ะทะฐะฟัะพั ะดะปั ะบะฐะถะดะพะน ัะฒัะทะธ.   
ะญัะพ ะผะพะถะตั ะฒัะทะฒะฐัั ะฟัะพะฑะปะตะผั N+1 ะทะฐะฟัะพัะพะฒ, ะพัะพะฑะตะฝะฝะพ ะฒ ัะธะบะปะฐั.

---

ะญัะธ ะผะตัะพะดั ัะตัะฐัั ะฟัะพะฑะปะตะผั ัะฐะบ:

    `select_related()` โ ะดะตะปะฐะตั SQL JOIN ะธ ะทะฐะณััะถะฐะตั ัะฒัะทะฐะฝะฝัะต ะพะฑัะตะบัั ััะฐะทั ะฒ ะพะดะฝะพะผ ะทะฐะฟัะพัะต.
    ๐ธ ะญััะตะบัะธะฒะฝะพ ะฟัะธ ัะฒัะทัั ForeignKey / OneToOne.

    `prefetch_related()` โ ะดะตะปะฐะตั ะพัะดะตะปัะฝัะน ะทะฐะฟัะพั ะบ ัะฒัะทะฐะฝะฝัะผ ะพะฑัะตะบัะฐะผ ะธ ัะฒัะทัะฒะฐะตั ะธั ะฒ Python.
    ๐ธ ะะพะดัะพะดะธั ะดะปั ManyToMany ะธ ะพะฑัะฐัะฝัั ัะฒัะทะตะน.


### ะ ััะผ ัะผััะป?
ะะตะฝััะต ะทะฐะฟัะพัะพะฒ โ ะฑััััะตะต ะฒัะฟะพะปะฝะตะฝะธะต ะบะพะดะฐ ะธ ะผะตะฝััะต ะฝะฐะณััะทะบะฐ ะฝะฐ ะฑะฐะทั ะดะฐะฝะฝัั.

| **ะะตัะพะด**            | **ะะฟะธัะฐะฝะธะต**                                                            | **ะะพะทะฒัะฐัะฐะตั** | **ะัะธะผะตั**                                       |
| -------------------- | ----------------------------------------------------------------------- | -------------- | ------------------------------------------------ |
| `select_related()`   | ะะตะปะฐะตั JOIN ะธ ะบััะธััะตั ัะฒัะทะฐะฝะฝัะน ะพะฑัะตะบั (FK)                            | `QuerySet`     | `Book.objects.select_related('publisher')`       |
| `prefetch_related()` | ะะฐะณััะถะฐะตั ัะฒัะทะฐะฝะฝัะต ะพะฑัะตะบัั ัะตัะตะท ะพัะดะตะปัะฝัะน ะทะฐะฟัะพั ะธ ัะฒัะทัะฒะฐะตั ะฒ Python | `QuerySet`     | `Publisher.objects.prefetch_related('book_set')` |

###  ะัะธะผะตั ะผะพะดะตะปะตะน ะดะปั ะพะฑะพะธั ะผะตัะพะดะพะฒ:

```python
class Book(models.Model):
    title = models.CharField(max_length=200)
    publisher = models.ForeignKey(Publisher, on_delete=models.CASCADE)

class Publisher(models.Model):
    name = models.CharField(max_length=100)
```

---

##  `select_related()`

ะัะฟะพะปัะทัะตััั ะดะปั **ForeignKey** ะธ **OneToOne** ัะฒัะทะตะน.   
ะัะฟะพะปะฝัะตั **SQL JOIN** ะธ ััะฐะทั ะทะฐะณััะถะฐะตั ัะฒัะทะฐะฝะฝัะต ะพะฑัะตะบัั.   
ะะฐะฑะพัะฐะตั ัััะตะบัะธะฒะฝะพ, ะฝะพ **ัะพะปัะบะพ ะดะปั "ะพะดะธะฝ-ะบ-ะพะดะฝะพะผั"** ะธะปะธ **"ะผะฝะพะณะธะต-ะบ-ะพะดะฝะพะผั"**.

---


ะะพะฟัััะธะผ, ะฒั ัะพัะธัะต ะพัะพะฑัะฐะทะธัั ัะฟะธัะพะบ ะบะฝะธะณ **ะฒะผะตััะต ั ะฝะฐะทะฒะฐะฝะธะตะผ ะธะทะดะฐัะตะปั**:

```python
for book in Book.objects.all():
    print(book.title, book.publisher.name)
```

---

## โ ะะตะท `select_related()`

```
ะะฐะฟัะพั 1:
SELECT * FROM book;

ะฆะธะบะป ะฟะพ ะบะฝะธะณะฐะผ:
โโโโโโโโโโโโโโโโโโโโโโโโ
โ Book 1 (publisher_id=3) โ
โโโโโโโโโโโโโโโโโโโโโโโโ
  โโ ะะฐะฟัะพั 2: SELECT * FROM publisher WHERE id=3;

โโโโโโโโโโโโโโโโโโโโโโโโ
โ Book 2 (publisher_id=5) โ
โโโโโโโโโโโโโโโโโโโโโโโโ
  โโ ะะฐะฟัะพั 3: SELECT * FROM publisher WHERE id=5;

...

โโโโโโโโโโโโโโโโโโโโโโโโ
โ Book N (publisher_id=X) โ
โโโโโโโโโโโโโโโโโโโโโโโโ
  โโ ะะฐะฟัะพั N+1: SELECT * FROM publisher WHERE id=X;
```

๐ ะัะพะณะพ: **1 + N ะทะฐะฟัะพัะพะฒ** โ ะฝะตัััะตะบัะธะฒะฝะพ, ะพัะพะฑะตะฝะฝะพ ะฟัะธ ะฑะพะปััะพะผ ะบะพะปะธัะตััะฒะต ะบะฝะธะณ.

---

## โ ะก `select_related('publisher')`

```python
books = Book.objects.select_related('publisher')
for book in books:
    print(book.title, book.publisher.name)
```

```
ะะฐะฟัะพั 1:
SELECT book.*, publisher.*
FROM book
JOIN publisher ON book.publisher_id = publisher.id;

ะะตะทัะปััะฐั:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Book 1 + Publisher.name                    โ
โ Book 2 + Publisher.name                    โ
โ ...                                        โ
โ Book N + Publisher.name                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

โ ะัะตะณะพ: **1 SQL-ะทะฐะฟัะพั ั JOIN'ะพะผ**
๐ฅ ะัะตะฝั ัััะตะบัะธะฒะฝะพ ะฟัะธ ัะฒัะทัั **ForeignKey** ะธ **OneToOne**

---


## `prefetch_related()`

### ะะพะดะตะปะธ:

```python
class Publisher(models.Model):
    name = models.CharField(max_length=100)

class Book(models.Model):
    title = models.CharField(max_length=200)
    publisher = models.ForeignKey(Publisher, on_delete=models.CASCADE)
```

ะขะตะฟะตัั ะฟะพะฟัะพะฑัะตะผ ะฒัะฒะตััะธ ัะฟะธัะพะบ ะธะทะดะฐัะตะปัััะฒ ะธ ะฝะฐะทะฒะฐะฝะธั ะธั ะบะฝะธะณ:

```python
for publisher in Publisher.objects.all():
    for book in publisher.book_set.all():
        print(publisher.name, book.title)
```

---

## โ ะงัะพ ะฟัะพะธััะพะดะธั ะฑะตะท `prefetch_related()`?

1. Django ะดะตะปะฐะตั **ะพะดะธะฝ ะทะฐะฟัะพั** ะฝะฐ `Publisher.objects.all()`.
2. ะะพัะพะผ โ **ะพัะดะตะปัะฝัะน ะทะฐะฟัะพั ะฝะฐ ะบะฐะถะดะพะต `publisher.book_set.all()`**.
3. ะัะพะณะพ: **1 + N** ะทะฐะฟัะพัะพะฒ (ะตัะปะธ 100 ะธะทะดะฐัะตะปัััะฒ โ ะฑัะดะตั 101 ะทะฐะฟัะพั).

---

### โ ะงัะพ ะดะตะปะฐะตั `prefetch_related('book_set')`?

ะัะตะถะดะต ะฒัะตะณะพ, [ััะพ ัะฐะบะพะต `book_set`](theory_13__what_is_book_set.md)?
```python
publishers = Publisher.objects.prefetch_related('book_set')
for publisher in publishers:
    for book in publisher.book_set.all():
        print(publisher.name, book.title)
```

Django ะดะตะปะฐะตั:

1. ะะดะธะฝ ะทะฐะฟัะพั ะฝะฐ `Publisher.objects.all()`
2. ะะดะธะฝ ะทะฐะฟัะพั ะฝะฐ ะฒัะต ัะฒัะทะฐะฝะฝัะต `Book` (ะณะดะต `publisher_id` ะฒ ัะฟะธัะพะบ id)

 ะะฐัะตะผ Django **ะฒ ะฟะฐะผััะธ ัะฒัะทัะฒะฐะตั ะบะฝะธะณะธ ั ะฝัะถะฝัะผะธ ะธะทะดะฐัะตะปัะผะธ**.  
 ะญัะพ ะฝะฐะผะฝะพะณะพ ัััะตะบัะธะฒะฝะตะต: **ัะพะปัะบะพ 2 SQL-ะทะฐะฟัะพัะฐ**, ะฝะตะทะฐะฒะธัะธะผะพ ะพั ะบะพะปะธัะตััะฒะฐ ะธะทะดะฐัะตะปัััะฒ.

---

### โ ะะตะท `prefetch_related()`

(ัะธะฟะธัะฝะฐั ะฟัะพะฑะปะตะผะฐ N+1 ะทะฐะฟัะพัะพะฒ):

```
ะะฐะฟัะพั 1:
SELECT * FROM publisher;

ะฆะธะบะป ะฟะพ ะธะทะดะฐัะตะปัะผ:
โโโโโโโโโโโโโโโโโโโโโโโ
โ Publisher 1         โ
โโโโโโโโโโโโโโโโโโโโโโโ
  โโ ะะฐะฟัะพั 2: SELECT * FROM book WHERE publisher_id = 1;

โโโโโโโโโโโโโโโโโโโโโโโ
โ Publisher 2         โ
โโโโโโโโโโโโโโโโโโโโโโโ
  โโ ะะฐะฟัะพั 3: SELECT * FROM book WHERE publisher_id = 2;

...

โโโโโโโโโโโโโโโโโโโโโโโ
โ Publisher N         โ
โโโโโโโโโโโโโโโโโโโโโโโ
  โโ ะะฐะฟัะพั N+1: SELECT * FROM book WHERE publisher_id = N;
```

๐ ะัะตะณะพ: **1 + N** SQL-ะทะฐะฟัะพัะพะฒ (ะพัะตะฝั ะฝะตัััะตะบัะธะฒะฝะพ ะฟัะธ ะฑะพะปััะพะผ ะบะพะปะธัะตััะฒะต ะดะฐะฝะฝัั)

---

### โ ะก `prefetch_related('book_set')`

```
ะะฐะฟัะพั 1:
SELECT * FROM publisher;

ะะฐะฟัะพั 2:
SELECT * FROM book WHERE publisher_id IN (1, 2, ..., N);

ะกะฒัะทั ะพะฑัะตะบัะพะฒ:
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Publisher 1  โ [Book A, Book B]             โ
โ Publisher 2  โ [Book C]                     โ
โ ...          โ ...                          โ
โ Publisher N  โ [Book X, Book Y, Book Z]     โ
โโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

โ ะัะตะณะพ: **2 ะทะฐะฟัะพัะฐ**, Django ัะฐะผ ะพะฑัะตะดะธะฝัะตั ะฒ Python ัะฒัะทะฐะฝะฝัะต ะพะฑัะตะบัั.
๐ฅ ะััััะพ, ะผะฐัััะฐะฑะธััะตะผะพ, ัะดะพะฑะฝะพ.

---

### ๐ ะัะฐัะบะพะต ััะฐะฒะฝะตะฝะธะต:

|              | `select_related()`              | `prefetch_related()`                |
| ------------ | ------------------------------- | ----------------------------------- |
| ะะฐะบ ัะฐะฑะพัะฐะตั | SQL JOIN                        | ะัะดะตะปัะฝัะน SQL + ัะฒัะทัะฒะฐะฝะธะต ะฒ Python |
| ะขะธะฟ ัะฒัะทะธ    | `ForeignKey`, `OneToOne`        | `ManyToMany`, ะพะฑัะฐัะฝัะต `ForeignKey` |
| ะะฐะฟัะพัะพะฒ     | 1                               | 2 (ะธะปะธ ะฑะพะปััะต, ะตัะปะธ ะผะฝะพะณะพ ัะฒัะทะตะน)   |
| ะะพะณะดะฐ ะปัััะต  | ะะพะณะดะฐ ะฝัะถะตะฝ ะดะพัััะฟ ะบ "ัะพะดะธัะตะปั" | ะะพะณะดะฐ ะฝัะถะตะฝ ะดะพัััะฟ ะบ "ะดะตััะผ"        |



